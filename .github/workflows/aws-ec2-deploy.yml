name: Deploy Backend to EC2

on:
  workflow_run:
    workflows: ['Publish Docker Image']
    types: [completed]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Cleanup old containers
        run: |
          docker compose down || true
          docker system prune -f
      
      - name: Pull latest image
        run: docker pull ${{ secrets.DOCKERHUB_USERNAME }}/todo-back-dockerize-ec2:latest
      
      - name: Start services
        run: docker compose up -d
      
      - name: Show running containers
        run: docker ps
      
      - name: Show logs
        run: docker compose logs --tail=50